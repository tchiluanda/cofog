---
title: "Untitled"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(networkD3)
library(shiny)
library(readxl)
library(ggplot2)
library(dplyr)
library(networkD3)
library(plotly)
library(viridis)
library(stringr)
library(readr)


COFOG_GC <- read_excel("COFOG GC.xlsx", 
                         sheet = "despesa_funcao", col_types = c("text", 
                                                                 "text", "skip", "skip", "skip", "skip", 
                                                                 "skip", "skip", "skip", "skip", "skip"), 
                         skip = 2)
  
  
names(COFOG_GC)<- c("codigo_cofog","descricao_cofog")

primeira_vez<<- TRUE

```


Visão geral
=====================================  
### Textos e infográficos falando do COFOG

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse aliquet orci vel laoreet scelerisque. Sed iaculis congue mi, at congue lectus mattis eget. Sed venenatis non dolor sit amet faucibus. Donec mollis sapien nec ligula elementum, vel finibus dolor interdum. Nullam elementum nibh ex, sit amet vehicula elit vulputate non. Sed pulvinar euismod pharetra. Nullam in enim lectus. Vivamus eu dolor enim. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Fusce euismod nulla non eros cursus, at sodales massa efficitur. Donec egestas nunc non enim consequat, tincidunt hendrerit orci tincidunt. Aenean cursus placerat maximus. Orci varius natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Nulla congue mattis enim ac pharetra. In hac habitasse platea dictumst. Integer finibus suscipit sem at dapibus.

Integer suscipit lacinia nibh, eget pellentesque nunc suscipit quis. Maecenas pretium eros ut interdum ullamcorper. Suspendisse potenti. Integer vitae convallis erat. Vivamus in lectus vitae lectus lobortis egestas. Proin eget urna in magna fringilla ultrices. Sed arcu justo, lacinia vel mattis at, mollis sed nisl. Sed at libero commodo metus scelerisque lobortis.

Aliquam ac tincidunt tellus, vitae mattis leo. Donec rhoncus magna massa, in rutrum metus maximus hendrerit. Mauris sagittis finibus nisl et feugiat. Phasellus urna ipsum, sagittis eu sodales et, condimentum sit amet augue. Integer sed interdum lacus, ut venenatis odio. Proin aliquet cursus accumsan. Duis eu mollis sapien.

Maecenas ultricies sagittis magna, eu dictum enim blandit vulputate. Integer efficitur mattis finibus. Maecenas pretium, justo non ultricies pulvinar, tortor augue fringilla eros, accumsan suscipit purus neque eu magna. Sed placerat, dolor vitae euismod finibus, lacus elit porttitor elit, nec dignissim risus est placerat mauris. Ut auctor ut nunc ac consequat. Aenean arcu eros, tincidunt in vulputate pharetra, laoreet eget lorem. Nulla eget aliquam elit, in volutpat ante. Aliquam vehicula, lorem ac sollicitudin mollis, nunc turpis interdum ante, sed maximus massa magna nec sem. Aliquam congue erat orci, a scelerisque metus porttitor eu. Donec facilisis sem eget metus fringilla, ac volutpat dui gravida.

Nam luctus euismod mauris ut mattis. Morbi mattis enim tortor, id molestie arcu semper ac. Cras aliquet lectus tortor, ut sagittis quam bibendum vitae. Praesent ex enim, viverra ac tincidunt at, consectetur gravida orci. In enim metus, feugiat id urna et, tempus ultricies libero. In a neque leo. In dignissim nisi augue, vel tincidunt mi vehicula at. Suspendisse ut magna massa. Sed ac scelerisque elit. Nullam lorem nunc, imperdiet ac magna eget, congue volutpat leo. Cras tristique tellus et lectus dapibus, at vehicula nunc fringilla. Nunc nisl elit, eleifend non facilisis non, viverra et nibh.





Fluxo Gastos COFOG
=====================================  

Inputs {.sidebar}
-------------------------------------

```{r}
# shiny inputs defined here


selectInput("ano","Ano",choices = c("2019":"2010"), selected = "2019")



```


Column {data-width=400}
-----------------------------------------------------------------------
### Principais achados

- Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec quis metus eu nibh congue convallis in non diam. Donec rhoncus vehicula dapibus. Proin in sodales nisi. Quisque id lectus sed est porta lobortis varius ac massa. Phasellus consequat augue eu lorem sollicitudin, ac vehicula massa rutrum. 

- Praesent eleifend sagittis orci ut pretium. Proin pulvinar sem consectetur interdum lobortis. Maecenas eleifend bibendum metus, pharetra fermentum ipsum interdum a. Nullam fringilla orci dolor. Suspendisse eget libero tempor, rutrum nisl id, laoreet mauris. Donec porttitor efficitur nibh. 

- Nam aliquet metus non lobortis laoreet. Sed suscipit fermentum eros, venenatis interdum tortor condimentum at. Duis vulputate condimentum purus eget iaculis. Fusce eleifend scelerisque enim suscipit iaculis. Proin ullamcorper vel ex non suscipit.


Column {.tabset .tabset-fade}
-----------------------------------------------------------------------
### Gráfico

```{r}
renderSankeyNetwork({
  library(readxl)
  library(ggplot2)
  library(dplyr)
  library(networkD3)
  
  
  #file<- paste0("Base-COFOG-","2019","-TT.xlsx")
  #file<-"Base-COFOG-2018-TT"
  file<- paste0("Base-COFOG-",input$ano,"-TT.xlsx")
  
  Base_COFOG <- read_excel(file)
  
  names(Base_COFOG)[13:14]<-c("valor","codigo_cofog")

  
  
  
  dados_cofog_pai<-
    Base_COFOG %>%
    mutate(codigo_cofog = stringr::str_sub(codigo_cofog,1,3)) %>%
    inner_join( COFOG_GC) %>%
    mutate(descricao_cofog_pai = "Gastos com funções de governo") %>%
    group_by(descricao_cofog_pai, descricao_cofog) %>%
    summarise(
      total_gasto = sum(valor)
    )
  
  dados_total<-
    dados_cofog_pai %>%
    ungroup() %>%
    mutate(descricao_cofog = descricao_cofog_pai) %>%
    mutate(descricao_cofog_pai = NA) %>%
    group_by(descricao_cofog_pai, descricao_cofog) %>%
    summarise(
      total_gasto = sum(total_gasto)
    )
  
  
  
  
  dados_cofog_raiz<-  
    Base_COFOG %>%
    mutate(codigo_pai = stringr::str_sub(codigo_cofog,1,3)) %>%
    inner_join( COFOG_GC) %>%
    mutate(codigo_filho = codigo_cofog) %>%
    mutate(descricao_cofog_filho = descricao_cofog) %>%
    mutate(codigo_cofog = codigo_pai) %>%
    select(codigo_pai,codigo_cofog, descricao_cofog_filho, valor) %>%
    inner_join( COFOG_GC) %>%
    mutate(descricao_cofog_pai = descricao_cofog ) %>%
    mutate(descricao_cofog = descricao_cofog_filho) %>%
    group_by(descricao_cofog_pai, descricao_cofog) %>%
    summarise(
      total_gasto = sum(valor)
    )
  
  dados_cofog_completo <-
    dados_cofog_pai %>%
    bind_rows(dados_cofog_raiz,
              dados_total)
  
  
  dados_cofog_completo<-
    dados_cofog_completo%>%
    ungroup() %>%
    mutate(total_gasto = total_gasto / 10^9) %>%
    mutate(descricao_cofog= reorder(descricao_cofog, total_gasto)) %>%
    arrange(desc(descricao_cofog)) %>%
    mutate (source = row_number() -1) 
  
  pai<-
    (dados_cofog_completo %>%
       filter(!is.na(descricao_cofog_pai)) %>%
       distinct(descricao_cofog_pai))$descricao_cofog_pai
  
  pos_pai <-
    dados_cofog_completo %>%
    filter(descricao_cofog %in% pai) %>%
    distinct(descricao_cofog, source) %>%
    mutate(descricao_cofog_pai =descricao_cofog ) %>%
    mutate(destination = source) %>%
    select(descricao_cofog_pai, destination)
  
  dados_net<-
    dados_cofog_completo %>%
    inner_join(pos_pai) 
  
  
  
  nodes<- 
    dados_cofog_completo %>%
    select(descricao_cofog, descricao_cofog_pai) 
  
  
  
  links<- 
    dados_net %>%
    select(source,
           destination,
           total_gasto)
  
  
  sankeyNetwork(Links = links, Nodes = nodes, Source = "source",
                Target = "destination", Value = "total_gasto", NodeID = "descricao_cofog",
                units = "", fontSize = 12, nodeWidth = 30, NodeGroup = "descricao_cofog_pai")
  
  
  
})



```

### Botetim do ano selecionado

```{r}

```

Especificação dos Gastos - Ação de governo
=====================================  

Inputs {.sidebar}
-------------------------------------

```{r}
# shiny inputs defined here


selectInput("ano_eg","Ano",choices = c("2019":"2010"), selected = "2019")
selectInput("acao", "Ação de governo", choices = "Ação de governo", multiple = TRUE)



```


Column {data-width=300}
-----------------------------------------------------------------------
### Principais achados

- Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec quis metus eu nibh congue convallis in non diam. Donec rhoncus vehicula dapibus. Proin in sodales nisi. Quisque id lectus sed est porta lobortis varius ac massa. Phasellus consequat augue eu lorem sollicitudin, ac vehicula massa rutrum. 

- Praesent eleifend sagittis orci ut pretium. Proin pulvinar sem consectetur interdum lobortis. Maecenas eleifend bibendum metus, pharetra fermentum ipsum interdum a. Nullam fringilla orci dolor. Suspendisse eget libero tempor, rutrum nisl id, laoreet mauris. Donec porttitor efficitur nibh. 

- Nam aliquet metus non lobortis laoreet. Sed suscipit fermentum eros, venenatis interdum tortor condimentum at. Duis vulputate condimentum purus eget iaculis. Fusce eleifend scelerisque enim suscipit iaculis. Proin ullamcorper vel ex non suscipit.


Column 
-----------------------------------------------------------------------

### Gráfico de distribuição por Ação Orçamentária

```{r}

renderPlot({
  
  #file<- paste0("Base-COFOG-",2019,"-TT.xlsx")
  file<- paste0("Base-COFOG-",input$ano_eg,"-TT.xlsx")
  
  Base_COFOG <- read_excel(file)
  
  names(Base_COFOG)[c(7,13:14)]<-c("acao_governo","valor","codigo_cofog")
  
  
  
  dados_cofog_completo <-
    Base_COFOG %>%
    mutate(codigo_cofog_pai = stringr::str_sub(codigo_cofog,1,3)) %>%
    inner_join(COFOG_GC) %>%
    inner_join(COFOG_GC, by = c("codigo_cofog_pai"="codigo_cofog")) %>%
    rename(descricao_cofog =  descricao_cofog.x,
           descricao_cofog_pai = descricao_cofog.y)%>%
    mutate(cofog_path = descricao_cofog_pai)
  
  
  
  dados_cofog_completo$tipo <- "Ação de governo"
  

  library(cluster)
  
  
  
  df_cluster<- 
    dados_cofog_completo %>%
    group_by(tipo, acao_governo, cofog_path) %>%
    summarise(
      total = sum(valor)
    ) %>%
    filter(total>0) %>%
    arrange(desc(total))
  
  set.seed(1972)
  #model<- pam(x = df_cluster[,4], k = 3)
  
  model<- kmeans(x= df_cluster[,4], centers = 3)
  
  

  dados_cofog_completo<-
  df_cluster %>%
      ungroup() %>%
    mutate(cluster = model$cluster,
           cluster = reorder(cluster, desc(cluster)),
           info_selecao = paste(acao_governo,cofog_path,cluster,sep="|"))
  


                
           
  
  if (primeira_vez){

      
    a_choices<- unique(dados_cofog_completo$info_selecao)
    a_selected<-(dados_cofog_completo %>%
                filter(cluster == 3) %>%
                select(info_selecao))$info_selecao
    
    #print(a_selected)  
    
    updateSelectInput(session, "acao",choices = a_choices, selected = a_selected)
    print("saiu IF")
    acao_sel<- input$acao
    
    primeira_vez <<- FALSE
    
    

    
  } else{
    acao_sel<- input$acao
  }
  

  dados_cofog_completo$tipo <- "Ação de governo"
  

  dados_filtrados<-
    dados_cofog_completo %>%
    filter(info_selecao %in% acao_sel)
  
  
  # print(
  # dados_cofog_completo %>%
  #               filter(cluster == 3))  
  # print(dados_filtrados)

  dados_cofog_completo %>%
    anti_join(dados_filtrados) %>%
    arrange(total) %>%
    mutate(cofog_path = reorder(cofog_path, total)) %>%
    ggplot(aes(x=str_wrap(cofog_path,15), y= total/10^3))+
    geom_jitter(color= "lightgray", size=4)+  
    geom_jitter(data= dados_filtrados, aes(color= str_wrap(factor(acao_governo) ,20)), size = 5)+
    #geom_text(aes(x=1.5,  label="Mudança de escala")) +
    scale_y_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE)) +
    scale_color_viridis(discrete=TRUE, option = "E") +
    theme_light()+ 
    theme(
      panel.grid = element_blank(),
      axis.text.x = element_text(),
      
    )+
  labs(color="Ação de governo",
       x="",
       y="Valor gasto no ano (R$ mil)") +
  facet_grid(cluster~., scales = "free_y" ,  space = "free_y") #+
  #annotate("text", x=1.5 , y=1000,  label= "<-Mudança de escala")
  #facet_grid(factor(cluster)~.,  space = "free_y")

  
  
})


```




Especificação dos Gastos - Unidade Orçamentária
=====================================  



Column {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Gráfico de distribuição por Unidade Orçamentária

```{r}


renderPlotly({
  
  #file<- paste0("Base-COFOG-",2019,"-TT.xlsx")
  file<- paste0("Base-COFOG-",input$ano_eg,"-TT.xlsx")
  
  Base_COFOG <- read_excel(file)
  
  names(Base_COFOG)[c(11,13:14)]<-c("unidade_orcamentaria","valor","codigo_cofog")
  
  
  
  dados_cofog_completo <-
    Base_COFOG %>%
    mutate(codigo_cofog_pai = stringr::str_sub(codigo_cofog,1,3)) %>%
    inner_join(COFOG_GC) %>%
    inner_join(COFOG_GC, by = c("codigo_cofog_pai"="codigo_cofog")) %>%
    rename(descricao_cofog =  descricao_cofog.x,
           descricao_cofog_pai = descricao_cofog.y)%>%
    mutate(cofog_path = paste(descricao_cofog_pai,descricao_cofog, sep = "-"))
  
  
  
  
           
  
  if (primeira_vez){

      
    a_choices<- unique(dados_cofog_completo$cofog_path)
    a_selected<- dados_cofog_completo$cofog_path[1]
    
    updateSelectInput(session, "cofog",choices = a_choices, selected = a_selected[1])
    print("saiu IF")
    cofog_sel<- input$cofog
    
    primeira_vez <<- FALSE
    
    

    
  } else{
    cofog_sel<- input$cofog
  }
  

  dados_cofog_completo$tipo <- "Unidades orçamentárias"
  
  mediana<- median(
    (dados_cofog_completo %>%
    group_by(unidade_orcamentaria, cofog_path) %>%
    summarise(
      total = sum(valor))
    )$total
    
  )
  
  dados_filtrados<-
    dados_cofog_completo %>%
    filter(cofog_path %in% cofog_sel) %>%
    group_by(tipo, unidade_orcamentaria, cofog_path) %>%
    summarise(
      total = sum(valor)
    ) 
  

  dados_cofog_completo %>%
    group_by(tipo, unidade_orcamentaria, cofog_path) %>%
    summarise(
      total = sum(valor)
    ) %>%
    filter(total>0) %>%
  ggplot(aes(x=str_wrap(cofog_path,20), y= total/10^6))+
    geom_jitter(color = "lightgrey")+  
     #geom_segment( aes(x=descricao, xend=descricao, y=0, yend=media ), color= "black", size= 1.0)+
    #geom_segment( aes(x=unidade_orcamentaria, xend=unidade_orcamentaria, y= total/10^6, yend=mediana ), color= "black", size= 1.0)+
    #geom_line(aes())
    geom_jitter(data= dados_filtrados, aes(color= str_wrap(factor(cofog_path) ,20)), alpha= 0.5) +
    scale_y_log10(labels=function(x) format(x, big.mark = ".", scientific = FALSE)) +
    scale_color_viridis(discrete=TRUE) +
    theme_light()+ 
    theme(
      panel.grid = element_blank(),
      axis.text.x = element_blank(),
      legend.position = "top"
    )+
  labs(color="Função de governo",
       x="",
       y="Valor gasto no ano (R$ mi)")
  
  
  
})


```

Especificação dos Gastos - Elemento de Despesa
=====================================  



Column {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Gráfico de distribuição por Elemento de Despesa

```{r}


renderPlotly({
  
  #file<- paste0("Base-COFOG-",2019,"-TT.xlsx")
  file<- paste0("Base-COFOG-",input$ano_eg,"-TT.xlsx")
  
  Base_COFOG <- read_excel(file)
  
  names(Base_COFOG)[c(3,13:14)]<-c("ndd","valor","codigo_cofog")
  
  
  
  dados_cofog_completo <-
    Base_COFOG %>%
    mutate(codigo_cofog_pai = stringr::str_sub(codigo_cofog,1,3)) %>%
    inner_join(COFOG_GC) %>%
    inner_join(COFOG_GC, by = c("codigo_cofog_pai"="codigo_cofog")) %>%
    rename(descricao_cofog =  descricao_cofog.x,
           descricao_cofog_pai = descricao_cofog.y)%>%
    mutate(cofog_path = paste(descricao_cofog_pai,descricao_cofog, sep = "-"))
  
  
  
  
           
  
  if (primeira_vez){

      
    a_choices<- unique(dados_cofog_completo$cofog_path)
    a_selected<- dados_cofog_completo$cofog_path[1]
    
    updateSelectInput(session, "cofog",choices = a_choices, selected = a_selected[1])
    print("saiu IF")
    cofog_sel<- input$cofog
    
    primeira_vez <<- FALSE
    
    

    
  } else{
    cofog_sel<- input$cofog
  }
  

  dados_cofog_completo$tipo <- "Elemento de Despesa"
  
  tab_elemento_despesa <- read_csv("tab_elemento_despesa.csv", 
    col_types = cols(elemento_despesa = col_character()))
  
  

  
  dados_filtrados<-
    dados_cofog_completo %>%
    filter(cofog_path %in% cofog_sel) %>%
    mutate(elemento_despesa = str_sub(ndd,2,2)) %>%
    inner_join(tab_elemento_despesa) %>%
    group_by(tipo, descricao_elemento_despesa, cofog_path) %>%
    summarise(
      total = sum(valor)
    ) 
  
  print(dados_filtrados)

  dados_cofog_completo %>%
    mutate(elemento_despesa = str_sub(ndd,2,2)) %>%
    inner_join(tab_elemento_despesa) %>%
    group_by(tipo, descricao_elemento_despesa, cofog_path) %>%
    summarise(
      total = sum(valor)
    ) %>%
    filter(total>0) %>%
  ggplot(aes(x=descricao_elemento_despesa, y= total/10^6))+
    geom_jitter(color = "lightgrey")+  
     #geom_segment( aes(x=descricao, xend=descricao, y=0, yend=media ), color= "black", size= 1.0)+
    #geom_segment( aes(x=unidade_orcamentaria, xend=unidade_orcamentaria, y= total/10^6, yend=mediana ), color= "black", size= 1.0)+
    #geom_line(aes())
    geom_jitter(data= dados_filtrados, aes(color= str_wrap(factor(cofog_path) ,20)), alpha= 0.5) +
    scale_y_log10(labels=function(x) format(x, big.mark = ".", scientific = FALSE)) +
    scale_color_viridis(discrete=TRUE) +
    theme_light()+ 
    theme(
      panel.grid = element_blank(),
      axis.text.x = element_text(angle = 90),
      #axis.text.x = element_blank(),
      legend.position = "top"
    )+
  labs(color="Função de Governo",
       x="",
       y="Valor gasto no ano (R$ mi)")
  
  
  
})


```
