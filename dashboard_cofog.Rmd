---
title: "Painel COFOG"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    social: menu
    source_code: https://github.com/tchiluanda/cofog
runtime: shiny
---

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-147616071-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-147616071-2');
</script>


```{r setup, include=FALSE}
library(flexdashboard)
library(networkD3)
library(shiny)
library(readxl)
library(ggplot2)
library(dplyr)
library(networkD3)
library(plotly)
library(viridis)
library(stringr)
library(readr)
library(Cairo)
library(ggrepel)
library(colorspace)
library(cluster)
library(tidyr)
library(stringr)

#novas libraries
library(purrr)


options(shiny.usecairo=T)

#Mudar essa atribuição a cada virada de ano
#cofog_ano_corrente<- "COFOGGCO290621.xlsx"

cofog_ano_corrente<- "COFOG-GCO.xlsx"
primeiro_ano<- 2010
ultimo_ano<-2021

num_skip<- ultimo_ano - 2010 + 1  

#"Source Sans Pro",Calibri,Candara,Arial,sans-serifbody

#tags$style(type="text/css", "text {font-family: Source Sans Pro}")

COFOG_GC <- read_excel(cofog_ano_corrente, 
                         sheet = "1.1", col_types = c("text", 
                                                                 "text", rep("skip",num_skip)), 
                         skip = 2)
  
  
names(COFOG_GC)<- c("codigo_cofog","descricao_cofog")

COFOG_GC<-
COFOG_GC %>%
  mutate(descricao_cofog = case_when(
    	descricao_cofog == "Despesa total3/" ~  "Despesa total" ,
    	descricao_cofog == "Transações da dívida pública4/" ~ "Transações da dívida pública",
    	descricao_cofog == "Educação infantil e ensino fundamental I5/"~ "Educação infantil e ensino fundamental I",
    	descricao_cofog == "Sobreviventes" ~"Pensionistas",
    	TRUE ~descricao_cofog
    	
    	
  ))


primeira_vez<<- TRUE
primeira_vez_elemento<<- TRUE

load("COFOG.RData")

#altera o nome das colunas para compatibilizar com o restante do código
Base_COFOG<-
 Base_COFOG %>%
    rename(ano = ano_de_lancamento,
           codigo_cofog= classificacao_cofog_codigo,
           descricao_cofog= classificacao_cofog_descricao,
           valor = valor_r_milhoes,
           funcao_economica = classificacao_economica_gfs_descricao_completa,
           acao_governo= acao_governo_descricao) %>%
  mutate(codigo_cofog = as.character(codigo_cofog))


tab_elemento_despesa <- read_csv("https://raw.githubusercontent.com/tchiluanda/cofog/master/tab_elemento_despesa.csv", 
    col_types = cols(elemento_despesa = col_character()))



get_dados_cofog_completo<- function(a_ano, a_cofog_path_completo =FALSE){
  names(Base_COFOG)[2]<-"ajustes"
  
  base_trabalho<-
  Base_COFOG %>%
    filter(ano==a_ano) %>%
    mutate(codigo_cofog_pai = stringr::str_sub(codigo_cofog,1,3),
           acao_governo = ifelse(acao_governo == "ND", ajustes,acao_governo)) %>%
    select(-descricao_cofog) %>%
    inner_join(COFOG_GC) %>%
    inner_join(COFOG_GC, by = c("codigo_cofog_pai"="codigo_cofog")) %>%
    rename(descricao_cofog =  descricao_cofog.x,
           descricao_cofog_pai = descricao_cofog.y)
  
  if (a_cofog_path_completo){
    base_trabalho%>%
    mutate(cofog_path = paste(descricao_cofog_pai, descricao_cofog))
  } else{
    
        base_trabalho%>%
    mutate(cofog_path = descricao_cofog_pai)

    
  }
  
}



get_top_n_funcao <- function(n){
    fun_sel<-
    base_grafico %>%
    filter(codigo_cofog_pai == 7) %>%
    group_by(descricao_cofog) %>%
    summarise(
      total= sum(valor)
    ) %>%
    slice_max(order_by = total,n=n) %>%
    ungroup() %>%
    select(descricao_cofog)
    
    fun_sel$descricao_cofog

  
}

dataExpenseFlow <- function(year=2020){
  
    Base_COFOG<-
  Base_COFOG %>%
    dplyr::filter(ano==year)

  
  
  
  dados_cofog_pai<-
    Base_COFOG %>%
    dplyr::mutate(codigo_cofog = stringr::str_sub(codigo_cofog,1,3)) %>%
    dplyr::select(-descricao_cofog) %>%
    dplyr::inner_join( COFOG_GC) %>%
    dplyr::mutate(descricao_cofog_pai = "Gastos com funções de governo") %>%
    dplyr::group_by(descricao_cofog_pai, descricao_cofog) %>%
    dplyr::summarise(
      total_gasto = sum(valor)
    )
  
  dados_total<-
    dados_cofog_pai %>%
    dplyr::ungroup() %>%
    dplyr::mutate(descricao_cofog = descricao_cofog_pai) %>%
    dplyr::mutate(descricao_cofog_pai = NA) %>%
    dplyr::group_by(descricao_cofog_pai, descricao_cofog) %>%
    dplyr::summarise(
      total_gasto = sum(total_gasto)
    )
  
  
  
  
  dados_cofog_raiz<-  
    Base_COFOG %>%
    dplyr::mutate(codigo_pai = stringr::str_sub(codigo_cofog,1,3)) %>%
    dplyr::select(-descricao_cofog) %>%
    dplyr::inner_join( COFOG_GC) %>%
    dplyr::mutate(codigo_filho = codigo_cofog) %>%
    dplyr::mutate(descricao_cofog_filho = descricao_cofog) %>%
    dplyr::mutate(codigo_cofog = codigo_pai) %>%
    dplyr::select(codigo_pai,codigo_cofog, descricao_cofog_filho, valor) %>%
    dplyr::inner_join( COFOG_GC) %>%
    dplyr::mutate(descricao_cofog_pai = descricao_cofog ) %>%
    dplyr::mutate(descricao_cofog = descricao_cofog_filho) %>%
    dplyr::group_by(descricao_cofog_pai, descricao_cofog) %>%
    dplyr::summarise(
      total_gasto = sum(valor)
    )
  
  dados_cofog_completo <-
    dados_cofog_pai %>%
    dplyr::bind_rows(dados_cofog_raiz,
              dados_total)
  
  
  dados_cofog_completo<-
    dados_cofog_completo%>%
    dplyr::ungroup() %>%
    dplyr::mutate(total_gasto = total_gasto / 10^3) %>%
    dplyr::mutate(descricao_cofog= reorder(descricao_cofog, total_gasto)) %>%
    dplyr::arrange(desc(descricao_cofog)) %>%
    dplyr::mutate (source = row_number() -1) 
  
  pai<-
    (dados_cofog_completo %>%
       dplyr::filter(!is.na(descricao_cofog_pai)) %>%
       dplyr::distinct(descricao_cofog_pai))$descricao_cofog_pai
  
  pos_pai <-
    dados_cofog_completo %>%
    dplyr::filter(descricao_cofog %in% pai) %>%
    dplyr::distinct(descricao_cofog, source) %>%
    dplyr::mutate(descricao_cofog_pai =descricao_cofog ) %>%
    dplyr::mutate(destination = source) %>%
    dplyr::select(descricao_cofog_pai, destination)
  
  dados_net<-
    dados_cofog_completo %>%
    dplyr::left_join(pos_pai) 
    
  .data<-dados_net
  
  .data


  
}


graphExpenseFlow <- function(.data){
  
  nodes<- 
    .data %>%
    dplyr::select(descricao_cofog, descricao_cofog_pai) 
  
  
  
  links<- 
    .data %>%
    dplyr::filter(!is.na(descricao_cofog_pai)) %>%
    dplyr::select(source,
           destination,
           total_gasto)
  
  
  networkD3::sankeyNetwork(Links = links, Nodes = nodes, Source = "source",
                Target = "destination", Value = "total_gasto", NodeID = "descricao_cofog",
                units = "", fontSize = 8, nodeWidth = 30, nodePadding =6, NodeGroup = "descricao_cofog_pai")

  
}


defineActionCluster <- function(year=2020) {
  
  .data <- get_dados_cofog_completo(year)

  
  df_cluster<- 
    .data %>%
    dplyr::group_by(acao_governo, cofog_path, unidade_orcamentaria_descricao) %>%
    dplyr::summarise(
      total = sum(valor)
    ) %>%
    dplyr::filter(total>0) %>%
    dplyr::arrange(desc(total))
    
  info<-sessioninfo::session_info()  
  
  if (info$platform$version != "R version 3.5.3 (2019-03-11)"){
   eval(parse(text='RNGkind(sample.kind = "Rounding")')) 
  }
  
    
  print("df_cluster")
  print(df_cluster)
  set.seed(1972)
  #model<- pam(x = df_cluster[,4], k = 3)
  
  model<- kmeans(x= df_cluster[,4], centers = 3)
  
  .data<-
  df_cluster %>%
      dplyr::ungroup() %>%
    dplyr::mutate(cluster = model$cluster,
           cluster = reorder(cluster, desc(cluster)),
           info_selecao = paste(acao_governo,cofog_path,cluster,sep="|"))
  print("passou pela definição de cluster")
  print(.data)
  .data


}

dataGovernmentAction <- function(.data,action, cluster=NULL){
  
  if(is.null(cluster)){
    filter_cluster<-c(1,2,3)
  } else{
    filter_cluster<-cluster
  }
  
  
  
  dados_filtrados<-
    .data %>%
    dplyr::filter(info_selecao %in% action,
           cluster %in% filter_cluster)
  
  .data<-
  .data %>%
    dplyr::filter(cluster %in% filter_cluster) %>%
    dplyr::anti_join(dados_filtrados)
  
  print("passou pela definição dos dados")
  print(.data)
  .data
}

updateGovernmentAction <- function(.data ){
  
  
  
  if (primeira_vez){
    
    print("primeira vez")
    a_choices<- unique(.data$info_selecao)
    a_selected<-(.data %>%
                   dplyr::filter(cluster %in% c(2,3)) %>%
                   dplyr::select(info_selecao))$info_selecao
    
    print(a_selected)  
    
    updateSelectInput(session, "acao",choices = a_choices, selected = a_selected)
    acao_sel<- input$acao
    
    primeira_vez <<- FALSE
    
    
  } else{
    print("segunda vez")
    acao_sel<- input$acao
  }
  
}


graphGovernmentAction <- function(.data, cluster= NULL, action){
  
  if(is.null(cluster)){
    filter_cluster<-c(1,2,3)
  } else{
    filter_cluster<-cluster
  }
  
  
  
  dados_filtrados<-
    .data %>%
    dplyr::filter(info_selecao %in% action,
                  cluster %in% filter_cluster)
  
  print("passou pela definição dos dados")
  print(.data)
  .data
  

  dados_alerta<-
    .data %>%
    dplyr::filter(cluster==3) %>%
    dplyr::group_by(cluster)%>%
    dplyr::summarise(
      min_total = min(total)/10^3
    )
  
  graph<-
    
    .data %>%
     filter(cluster %in% filter_cluster) %>%
     anti_join(dados_filtrados) %>%
    ggplot2::ggplot(ggplot2::aes(x=stringr::str_wrap(cofog_path,15), y= total/10^3))+ 
    ggplot2::geom_jitter(ggplot2::aes(fill= cofog_path), show.legend = FALSE, size=4, height = 0, width = ifelse(.data$cluster==1,0.4,0.1), alpha = 0.3, pch=21, color="white")+  
    ggplot2::geom_jitter( data= dados_filtrados,  size = 4, show.legend = FALSE, height = 0, width = ifelse(dados_filtrados$cluster==1,0.2,0.1),alpha = 0.5, fill = "black", pch=21, color="white") +
    ggrepel::geom_text_repel(data= dados_filtrados,
                             ggplot2::aes(label = stringr::str_wrap(paste(stringr::str_to_lower(acao_governo) ,
                                                                          as.character(round(total/10^3,2)), sep=": "),20) ),  
                             show.legend = FALSE, 
                             box.padding = ggplot2::unit(1, "lines"), 
                             color = "black", 
                             alpha =0.8, 
                             size =3,
                             set.seed = 1972,
                             segment.linetype = 5,
                             segment.alpha = 0.5) +
    
    ggplot2::scale_y_continuous(labels=function(x) format(x,decimal.mark=",", big.mark = ".", scientific = FALSE)) +
    colorspace::scale_color_discrete_qualitative(palette = "Dark 3")+
    ggplot2::theme_light()+ 
    ggplot2::theme(
      panel.grid = ggplot2::element_blank(),
      axis.text.x = ggplot2::element_text()
      
    )+
    ggplot2::labs(fill="",
                  x="",
                  y="Valor gasto no ano (R$ bi)") +
    ggplot2::facet_grid(cluster~., scales = "free_y" ,  space = "free_y")
  
  
  
  if (is.null(cluster)){
    graph<- 
      graph+ 
      ggplot2::geom_text(data = dados_alerta, ggplot2::aes(x=1.2, y= min_total,  label="<---Mudança de escala"), color = "red")
  }
  
  graph
}


dataEconomicClassification<- function(year=2020){
  
  a_ano<-year

  indice_sheet<-as.numeric(a_ano)-2010+1
  sheet<- paste0("2.",indice_sheet)
  
  
  COFOG_GC_names<- read_excel(cofog_ano_corrente, sheet = sheet, 
                         skip = 2, n_max = 1) 
  
  COFOG_GC_dados <- read_excel(cofog_ano_corrente, sheet = sheet, 
                         skip = 4)
  
  COFOG_GC<- COFOG_GC_dados
  
  names(COFOG_GC)<- names(COFOG_GC_names)
  names(COFOG_GC)[1]<-"codigo_cofog"
  names(COFOG_GC)[2]<-"descricao_cofog"
  
  COFOG_GC[,3]<-  COFOG_GC_dados[,3]+
             COFOG_GC_dados[,4]+
             COFOG_GC_dados[,5]
  
  COFOG_GC <- COFOG_GC[,-c(4:5)]

  COFOG_GC_gather<-
    COFOG_GC %>%
    select(-11)%>%
    gather(funcao_economica, valor, -c(1,2)) %>%
    filter(codigo_cofog!="7") %>%
    mutate(funcao_economica = str_sub(funcao_economica,5,100),
           codigo_cofog_pai = ifelse(str_length(codigo_cofog)==3,"7",str_sub(codigo_cofog,1,3)) )
  
  COFOG_GC_gather<-
  COFOG_GC_gather%>%
    mutate(descricao_cofog = case_when(
      descricao_cofog == "Despesa total3" ~  "Despesa total" ,
      descricao_cofog == "Transações da dívida pública4" ~ "Transações da dívida pública",
      descricao_cofog == "Educação infantil e ensino fundamental I5"~ "Educação infantil e ensino fundamental I",
      descricao_cofog == "Sobreviventes" ~"Pensionistas",
      TRUE ~descricao_cofog
    )) %>%
    mutate(funcao_economica = case_when(
      	 funcao_economica == " Juros4" ~  "Juros",
      	 funcao_economica == " Remuneração de empregados6" ~ "Remuneração de empregados",
      	 funcao_economica == " Investimento bruto 7/" ~  "Investimento bruto",
      	 funcao_economica == " Investimento bruto em ativos não financeiros7" ~ "Investimento bruto em ativos não financeiros",
      	 TRUE ~ funcao_economica
    ))
  
  COFOG_GC_gather$ano<- a_ano

  .data<- COFOG_GC_gather
  .data
}



graphEconomicClassification <- function(.data, free_scale= TRUE){
  
  graph<-
    .data %>%
    dplyr::filter(codigo_cofog_pai == "7") %>%
    dplyr::mutate(descricao_cofog = reorder(descricao_cofog, valor),
           funcao_economica = reorder(funcao_economica, desc(valor))) %>% 
    ggplot2::ggplot(aes(x=factor(descricao_cofog),valor, fill= funcao_economica))+
    ggplot2::geom_col(color = "white")+
    viridis::scale_fill_viridis(discrete=TRUE) +
    ggplot2::scale_y_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE)) +
    ggplot2::theme_light()+ 
    theme(
      panel.grid = ggplot2::element_blank(),
      axis.text.x = ggplot2::element_text(angle = 90),
      #axis.text.x = element_blank(),
      legend.position = "",
      strip.background = ggplot2::element_blank(),
      strip.text = ggplot2::element_text(color = "black")
    )+
    ggplot2::labs(color="",
         x="",
         y="Valor gasto no ano (R$ mi)")+
    ggplot2::coord_flip()
  
  if (free_scale){
    graph+
      ggplot2::facet_wrap(funcao_economica~., scales = "free_x")
  } else{
    graph+
      ggplot2::facet_wrap(funcao_economica~.)
  }
  
  
}


dataEconomicSubFunction<- function(year=2020, sel_function){
  
  dados_economicos <- dataEconomicClassification(year)
  
  .data<- 
  dados_economicos %>%
  filter(codigo_cofog_pai %in% (dados_economicos %>%
                               filter(descricao_cofog == sel_function) %>%
                               select(codigo_cofog))$codigo_cofog)
  
  .data

  
}

graphEconomicSubFunction<-  function(.data,free_scale=TRUE){
  
  graph<-
  .data %>%
  dplyr::mutate(descricao_cofog = reorder(descricao_cofog, valor),
         funcao_economica = reorder(funcao_economica, desc(valor))) %>% 
  ggplot2::ggplot(aes(x=factor(descricao_cofog),valor, fill= funcao_economica))+
    ggplot2::geom_col(color = "white")+
    viridis::scale_fill_viridis(discrete=TRUE) +
    ggplot2::scale_y_continuous(labels=function(x) format(x, big.mark = ".", scientific = FALSE)) +
    ggplot2::theme_light()+ 
    ggplot2::theme(
      panel.grid = ggplot2::element_blank(),
      axis.text.x = ggplot2::element_text(angle = 90),
      legend.position = "",
      strip.background = ggplot2::element_blank(),
      strip.text = ggplot2::element_text(color = "black")
    )+
  ggplot2::labs(color="",
       x="",
       y="Valor gasto no ano (R$ mi)")+
      
    ggplot2::coord_flip()
  
  if (free_scale){
    graph+
    ggplot2::facet_wrap(funcao_economica~., scales = "free_x")
  } else{
    graph+
    ggplot2::facet_wrap(funcao_economica~.)
  }

  
  
}

dataTimeSeries<- function(sel_function){
  
  despesa_total_anual<-
    base_grafico %>%
    dplyr::filter(codigo_cofog_pai == 7) %>%
    dplyr::mutate(ano = as.character(ano)) %>%
    group_by(ano) %>%
    dplyr::summarise(
      total_ano = sum(valor)
    )
  

  
  .data<-
    base_grafico %>%
    dplyr::filter(descricao_cofog %in% sel_function) %>%
    dplyr::mutate(ano = as.character(ano)) %>%
    dplyr::group_by(ano, descricao_cofog) %>%
    dplyr::summarise(
      total = sum(valor)
    ) %>%
    dplyr::inner_join(despesa_total_anual)
  
  .data

  
}

graphTimeSeries <- function(.data){
  
  graph<-
    .data %>%
    dplyr::mutate(percentual =round((total/total_ano)*100,2)) %>%
    dplyr::rename(Função = descricao_cofog) %>%
    dplyr::mutate(Função = str_wrap(Função,20) ) %>%
    ggplot2::ggplot()+
    ggplot2::geom_line(ggplot2::aes(x= ano, y= percentual, group = Função, color = Função)) +
    viridis::scale_color_viridis(discrete = TRUE) +
    ggplot2::scale_y_continuous(labels=function(x) format(x, big.mark = ".",decimal.mark = ",", scientific = FALSE)) +
    ggplot2::theme_light()+ 
    ggplot2::theme(
      panel.grid = ggplot2::element_blank()
    )+
    ggplot2::labs(color= stringr::str_wrap("Função",20),
                  x="",
                  y="% do gasto total")
  
  
  plotly::ggplotly(graph, tooltip = c("x","y","colour"))
  
}


dataYearlyDistributionPercentage <- function() {
    top_4<-
    base_grafico %>%
    dplyr::filter(descricao_cofog %in% get_top_n_funcao(4)) %>%
    dplyr::mutate(ano = as.character(ano)) %>%
    dplyr::group_by(ano, descricao_cofog) %>%
    dplyr::summarise(
      total = sum(valor)
    ) %>%
    dplyr::ungroup()
  
  
  
  
  demais <-
    base_grafico %>%
    dplyr::filter( codigo_cofog_pai == 7,
            !descricao_cofog %in% get_top_n_funcao(4) ) %>%
    dplyr::mutate(ano = as.character(ano)) %>%
    dplyr::mutate(descricao_cofog = "Demais funções") %>%
    dplyr::group_by(ano, descricao_cofog) %>%
    dplyr::summarise(
      total = sum(valor)
    ) %>%
    dplyr::ungroup()
  
  .data<-
  top_4%>%
    dplyr::bind_rows(
      demais
    )
  
  .data
  
} 


graphYearlyDistributionPercentage <- function(.data) {
  
   .data%>%
    dplyr::mutate(descricao_cofog = reorder(descricao_cofog, total)) %>%
    ggplot2::ggplot()+
    ggplot2::geom_col(ggplot2::aes(x=ano, y= total, fill= descricao_cofog), position = "fill") +
    viridis::scale_fill_viridis(discrete = TRUE)+
    ggplot2::theme_light()+ 
    ggplot2::theme(
      panel.grid = ggplot2::element_blank()
    )+
    ggplot2::labs(fill=str_wrap("Função",20),
         x="",
         y="% do gasto total")
  
}


########################################
base_grafico<- 
  map_dfr(primeiro_ano:ultimo_ano, dataEconomicClassification) %>%
  mutate(descricao_cofog = case_when(
    	descricao_cofog == "Despesa total3/" ~  "Despesa total" ,
    	descricao_cofog == "Transações da dívida pública4/" ~ "Transações da dívida pública",
    	descricao_cofog == "Educação infantil e ensino fundamental I5/"~ "Educação infantil e ensino fundamental I",
    	descricao_cofog == "Sobreviventes" ~"Pensionistas",
    	TRUE ~descricao_cofog
    	
    	
  ))





```


Visão geral
=====================================  
### As despesas nas funções de Governo (COFOG)


```{r}

renderUI({
  
   tags$iframe(src = "https://tchiluanda.github.io/cofog/", height="100%", width="100%")
  

})



```






Fluxo Despesas COFOG
=====================================  

Inputs {.sidebar}
-------------------------------------

```{r}
# shiny inputs defined here


selectInput("ano","Ano",choices = c(ultimo_ano:primeiro_ano), selected = ultimo_ano)

# Create placeholder for the downloadButton
uiOutput("downloadUI_sankey")
# Create the actual downloadButton
output$downloadUI_sankey <- renderUI( {
  downloadButton("download_sankey","Download dados", style = "width:100%;")
})


#downloadLink("download_sankey","Download dados\n\r")

output$download_sankey<- downloadHandler(
  filename = function() {
    paste('dados_sankey',  '.csv', sep='')
  },
  content = function(file) {
    
    dados_sankey <- dataExpenseFlow(input$ano)
    write.table(dados_sankey, file, sep = ";",row.names = FALSE,fileEncoding = "UTF-8",dec=",")
  }
)



```


Column 
-----------------------------------------------------------------------
### Gráfico do fluxo de despesas (Valores em R$ bi)

```{r}

# tags$style("
#               body {
#     -moz-transform: scale(0.80, 0.80); /* Moz-browsers */
#     zoom: 0.80; /* Other non-webkit browsers */
#     zoom: 80%; /* Webkit browsers */
# }
#              ")

renderSankeyNetwork({
  
  #dataExpenseFlow() %>%
    #graphExpenseFlow()
  
  dataExpenseFlow(input$ano) %>%
    graphExpenseFlow()

})



```

Ação de Governo 
=====================================  

Inputs {.sidebar}
-------------------------------------

```{r}
# shiny inputs defined here

selectInput("ano_eg","Ano",choices = c(ultimo_ano:primeiro_ano), selected = ultimo_ano)
checkboxGroupInput ("zoom","Zoom no(s) agrupamento(s)", choices = c("1", "2") )
actionButton("limpar", "Limpar Filtro")
selectInput("acao", "Ação de governo", choices = "Ação de governo", multiple = TRUE)

# Create placeholder for the downloadButton
uiOutput("downloadUI_distribuicao")
# Create the actual downloadButton
output$downloadUI_distribuicao <- renderUI( {
  downloadButton("download_distribuicao","Download dados", style = "width:100%;")
})


#downloadLink("download_distribuicao","Download dados")

output$download_distribuicao<- downloadHandler(
  filename = function() {
    paste('dados_distribuicao',  '.csv', sep='')
  },
  content = function(file) {
    
    dados_distribuicao<-  defineActionCluster(year= input$ano_eg)
    write.table(dados_distribuicao, file, sep = ";",row.names = FALSE,fileEncoding = "UTF-8",dec=",")
  }
)




```

```{r}
observeEvent(input$ano_eg, {
  
  primeira_vez<<- TRUE
  
  

})


observeEvent(input$acao, {
  

  primeira_vez<<- FALSE
  

})


observeEvent(input$limpar, {
  
  print("Botão pressionado")
  updateSelectInput(session = session, inputId = "acao", selected = "")
  

})

```




Column 
-----------------------------------------------------------------------


### Gráfico de distribuição por Ação de Governo (Valores em R$ bi)

```{r}

renderPlot({
  
 #defineActionCluster() %>%
 #graphGovernmentAction(action = a_selected)

  
  dados_acao<- defineActionCluster(year= input$ano_eg)
  
  if (primeira_vez) {
    updateGovernmentAction(dados_acao)
  }
  
  graphGovernmentAction(dados_acao,action = input$acao, cluster = input$zoom)
  
  

})


```

Classificação Econômica
=====================================  

Inputs {.sidebar}
-------------------------------------

```{r}
# shiny inputs defined here

selectInput("ano_ed","Ano",choices = c(ultimo_ano:primeiro_ano), selected = ultimo_ano)
checkboxInput("escala","Escala livre", value = FALSE )
selectInput("zoom_ed","Escolha um tipo de gasto para detalhar na segunda aba", choices = "Serviços públicos gerais", selected = "Serviços públicos gerais")


# Create placeholder for the downloadButton
uiOutput("downloadUI_func")
uiOutput("downloadUI_sub_func")
```

```{r}
# Create the actual downloadButton
output$downloadUI_func <- renderUI( {
  downloadButton("download_classificacao_funcao","Download dados", style = "width:100%;")
})

output$downloadUI_sub_func <- renderUI( {
  downloadButton("download_classificacao_subfuncao","Download dados sub-função", style = "width:100%;")
})



output$download_classificacao_funcao<- downloadHandler(
  filename = function() {
    paste('dados_classificacao_funcao',  '.csv', sep='')
  },
  content = function(file) {
    
    dados_classificacao_funcao<- dataEconomicClassification(input$ano_ed)
    write.table(dados_classificacao_funcao, file, sep = ";",row.names = FALSE,fileEncoding = "UTF-8",dec=",")
  }
)

output$download_classificacao_subfuncao<- downloadHandler(
  filename = function() {
    paste('dados_classificacao_subfuncao',  '.csv', sep='')
  },
  content = function(file) {
    
    dados_classificacao_subfuncao<- dataEconomicSubFunction (year =input$ano_ed, sel_function = input$zoom_ed )
    write.table(dados_classificacao_subfuncao, file, sep = ";",row.names = FALSE,fileEncoding = "UTF-8",dec=",")
  }
)


```

Column {.tabset .tabset-fade}
-----------------------------------------------------------------------


### Gráfico de distribuição por Classificação Econômica

```{r}


renderPlot({
  
  dataEconomicClassification(input$ano_ed) %>%
    graphEconomicClassification(input$escala)
  
  

})


```


### Detalhamento por Função de Governo

```{r}

renderPlot({

  #dados_economicos <- dataEconomicClassification(2019)
  dados_economicos <- dataEconomicClassification(input$ano_ed)



  if (primeira_vez_elemento){
    choice<- 
      dados_economicos %>%
      filter(codigo_cofog_pai == "7") %>%
      arrange(desc(valor)) %>%
      select(descricao_cofog)
    
    #print(choice)
    
    
    a_choice<- choice$descricao_cofog
    
    #print(a_choice[1])
    updateSelectInput(session = session, inputId = "zoom_ed", choices = a_choice, selected = a_choice[1] )
    
    primeira_vez_elemento<<- FALSE
    
    func_sel<- input$zoom_ed
    
    #print(func_sel)
    
  } else{
    func_sel<- input$zoom_ed
  }
  

  # dataEconomicSubFunction(sel_function = a_choice[1]) %>%
  #   graphEconomicSubFunction(TRUE)
  
  dataEconomicSubFunction (year =input$ano_ed, sel_function = func_sel ) %>%
    graphEconomicSubFunction(input$escala)

})



```

Séries temporais
=====================================  

Inputs {.sidebar}
-------------------------------------

```{r}
# shiny inputs defined here

selectInput("funcao_serie","Escolha uma ou mais funções",choices = unique(base_grafico$descricao_cofog), selected = get_top_n_funcao(5), multiple = TRUE)


# Create placeholder for the downloadButton
uiOutput("downloadUI_serie")

```

```{r}
# Create the actual downloadButton
output$downloadUI_serie <- renderUI( {
  downloadButton("download_serie","Download dados", style = "width:100%;")
})



output$download_serie<- downloadHandler(
  filename = function() {
    paste('dados_serie_funcao',  '.csv', sep='')
  },
  content = function(file) {
    
    dados_serie <- dataTimeSeries(sel_function = input$funcao_serie)
    write.table(dados_serie, file, sep = ";",row.names = FALSE,fileEncoding = "UTF-8",dec=",")
  }
)



```

Column
-----------------------------------------------------------------------

### Série temporal de função de governo

```{r}

renderPlotly({
  
  dataTimeSeries(sel_function = input$funcao_serie) %>%
    graphTimeSeries()
  

})



```


Distribuição percentual anual
=====================================  


Inputs {.sidebar}
-------------------------------------

```{r}


# Create placeholder for the downloadButton
uiOutput("downloadUI_percentual")

# Create the actual downloadButton
output$downloadUI_percentual <- renderUI( {
  downloadButton("download_percentual","Download dados", style = "width:100%;")
})



output$download_percentual<- downloadHandler(
  filename = function() {
    paste('dados_percentual_funcao',  '.csv', sep='')
  },
  content = function(file) {
    
    dados_percentual <- dataYearlyDistributionPercentage()
    write.table(dados_percentual, file, sep = ";",row.names = FALSE,fileEncoding = "UTF-8",dec=",")
  }
)

```

Column
-----------------------------------------------------------------------

### Distribuição anual dos gastos para as principais funções

```{r}

renderPlot({
  
  
  dataYearlyDistributionPercentage() %>%
    graphYearlyDistributionPercentage()
  
})


```

